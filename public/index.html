<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-TF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Game Platform - Home</title>
		<link rel="stylesheet" href="/css/style.css" />
	</head>
	<body>
		<div class="w-full h-full lg:p-10 p-3 flex flex-col min-[52rem]:grid grid-cols-3 gap-5">
			<h1 class="text-center col-span-3 pt-10 text-4xl pb-3">Fun With Friends</h1>
			<p class="col-span-3 text-center max-w-2xl mx-auto">Have fun with your friends with simple yet entertaining couch-like games. Choose a game, enter your username, create or join a room, and start playing together!</p>

			<div class="flex flex-col border border-primary rounded-sm p-5 gap-4">
				<label for="usernameInput">Username:</label>
				<input class="input w-full" type="text" id="usernameInput" placeholder="Enter your username" />
				<div class="flex gap-3 shrink">
					<div class="dropdown">
						<div tabindex="0" role="button" class="grow btn btn-square bg-base-content text-base-100 my-1">
							<span class="icon-[proicons--dark-theme] text-2xl"></span>
						</div>
						<ul tabindex="0" class="dropdown-content bg-base-300 rounded-box z-1 w-52 p-2 shadow-2xl">
							<li>
								<input type="radio" name="theme-dropdown" class="theme-controller w-full btn btn-sm btn-ghost justify-start" aria-label="default" value="default" />
							</li>
							<li>
								<input type="radio" name="theme-dropdown" class="theme-controller w-full btn btn-sm btn-ghost justify-start" aria-label="light" value="light" />
							</li>
							<li>
								<input type="radio" name="theme-dropdown" class="theme-controller w-full btn btn-sm btn-ghost justify-start" aria-label="dark" value="dark" />
							</li>
							<li>
								<input type="radio" name="theme-dropdown" class="theme-controller w-full btn btn-sm btn-ghost justify-start" aria-label="dim" value="dim" />
							</li>
							<li>
								<input type="radio" name="theme-dropdown" class="theme-controller w-full btn btn-sm btn-ghost justify-start" aria-label="nord" value="nord" />
							</li>
						</ul>
						<script>
							document.addEventListener("DOMContentLoaded", function () {
								const themeControllers = document.querySelectorAll(".theme-controller");
								const savedTheme = localStorage.getItem("selectedTheme");
								if (!savedTheme) {
									const systemTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
									document.documentElement.setAttribute("data-theme", systemTheme);
									if (themeControllers) {
										themeControllers.forEach((controller) => {
											if (controller.value === systemTheme) {
												controller.checked = true;
											}
										});
									}
								} else {
									document.documentElement.setAttribute("data-theme", savedTheme);
									if (themeControllers) {
										themeControllers.forEach((controller) => {
											if (controller.value === savedTheme) {
												controller.checked = true;
											}
										});
									}
								}

								if (themeControllers) {
									themeControllers.forEach((controller) => {
										controller.addEventListener("change", function () {
											const selectedTheme = this.value;
											if (selectedTheme == "default") {
												const systemTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
												document.documentElement.setAttribute("data-theme", systemTheme);
												localStorage.removeItem("selectedTheme");
											} else {
												localStorage.setItem("selectedTheme", selectedTheme);
												document.documentElement.setAttribute("data-theme", selectedTheme);
											}
										});
									});
								}
							});
						</script>
					</div>
					<script type="text/javascript" src="https://storage.ko-fi.com/cdn/widget/Widget_2.js"></script>
					<script type="text/javascript">
						kofiwidget2.init("Buy me Coffe", "#343a40", "P5P41EVJTV");
						kofiwidget2.draw();
					</script>
				</div>
			</div>

			<div class="flex flex-col border border-primary rounded-sm p-5 gap-4">
				<label for="gameTypeSelect">Select Game Type:</label>
				<select class="select w-full" id="gameTypeSelect">
					<option disabled selected>Pick a game</option>
					<!-- Options will be populated by JS -->
				</select>
				<button class="btn btn-primary" id="createRoomButton">Create Room</button>
			</div>

			<div class="flex flex-col border border-primary rounded-sm p-5 gap-4">
				<label for="roomIdInput">Join a Room:</label>
				<input class="input w-full" type="text" id="roomIdInput" placeholder="Enter Room ID" />
				<button class="btn btn-primary" id="joinRoomButton">Join Room</button>
			</div>

			<div class="flex flex-col gap-4 col-span-3 w-full border rounded-sm border-primary p-4 mt-10">
				<label>Available Rooms:</label>
				<div class="md:grid lg:grid-cols-3 grid-cols-2 flex flex-col gap-5" id="availableRoomsList"></div>
			</div>
		</div>

		<script src="/socket.io/socket.io.js"></script>
		<script>
			const socket = io(); // Connect to the server

			const gameTypeSelect = document.getElementById("gameTypeSelect");
			const usernameInput = document.getElementById("usernameInput");
			const createRoomButton = document.getElementById("createRoomButton");
			const roomIdInput = document.getElementById("roomIdInput");
			const joinRoomButton = document.getElementById("joinRoomButton");
			const availableRoomsList = document.getElementById("availableRoomsList");

			// Fetch game types for the dropdown
			fetch("/api/games")
				.then((res) => res.json())
				.then((gameTypes) => {
					gameTypes.forEach((game) => {
						const option = document.createElement("option");
						option.value = game.id;
						option.textContent = game.name;
						gameTypeSelect.appendChild(option);
					});
				});

			// Fetch and display available rooms
			function fetchAvailableRooms() {
				socket.emit("room_list_request"); // Requesting via socket event
			}

			socket.on("available_rooms", (rooms) => {
				console.log(rooms);
				availableRoomsList.innerHTML = ""; // Clear existing list
				if (rooms.length === 0) {
					const li = document.createElement("li");
					li.textContent = "No rooms available. Create one!";
					availableRoomsList.appendChild(li);
					return;
				}

				rooms.forEach((room) => {
					const li = document.createElement("div");
					li.className = `flex flex-col bg-base-200 ${room.colorCode == 1 ? "!bg-amber-600/10 dark:!bg-amber-300/5" : ""} p-5 rounded cursor-pointer outline outline-transparent hover:outline-accent transition-all`;
					li.classList.add("room-item"); // Add a class for styling and selection

					let roomStatusText = room.status;
					if (room.status === "waiting" || room.status === "ready") {
						// "ready" if min players met but not started
						roomStatusText = "Waiting for players";
					} else if (room.status === "in-progress") {
						roomStatusText = "In Progress";
					} else if (room.status === "finished") {
						roomStatusText = "Finished";
					}

					li.innerHTML = `
						<div class="room-name">${`Room <span class="text-cyan-600 dark:text-cyan-400 underline">${room.id}</span>`} (${room.gameType})</div>
						<div class="room-players">Players: ${room.playerCount}/${room.capacity}</div>
						<div class="room-status">Status: ${roomStatusText}</div>
					`;

					// Make the room item clickable to join, if joinable
					if (room.status === "waiting" || room.status === "ready") {
						// Only allow joining waiting/ready rooms
						if (room.playerCount < room.capacity) {
							li.classList.add("joinable");
							li.title = "Click to join this room";
							li.addEventListener("click", () => {
								const username = usernameInput.value.trim();
								if (!username) {
									alert("Please enter a username before joining a room.");
									usernameInput.focus();
									return;
								}
								console.log(`Attempting to join room: ${room.id} as ${username}`);
								socket.emit("join_room", { roomId: room.id, username });
							});
						} else {
							li.classList.add("full");
							li.title = "This room is full.";
						}
					} else {
						li.classList.add("not-joinable");
						li.title = `Cannot join, game is ${room.status}.`;
					}
					availableRoomsList.appendChild(li);
				});
			});

			fetchAvailableRooms(); // Initial fetch
			setInterval(fetchAvailableRooms, 5000); // Refresh periodically

			createRoomButton.addEventListener("click", () => {
				const gameType = gameTypeSelect.value;
				const username = usernameInput.value.trim();
				if (!username) {
					alert("Please enter a username.");
					return;
				}
				if (!gameType) {
					alert("Please select a game type.");
					return;
				}
				socket.emit("create_room", { gameType, username });
			});

			joinRoomButton.addEventListener("click", () => {
				const roomId = roomIdInput.value.trim();
				const username = usernameInput.value.trim();
				if (!username) {
					alert("Please enter a username.");
					return;
				}
				if (!roomId) {
					alert("Please enter a Room ID.");
					return;
				}
				socket.emit("join_room", { roomId, username });
			});

			socket.on("room_created", (data) => {
				alert(`Room created! ID: ${data.roomId}. Joining game type: ${data.gameType}`);
				sessionStorage.setItem("reestablishRoomId", data.roomId);
				sessionStorage.setItem("reestablishUsername", usernameInput.value.trim()); // Username used for creation
				sessionStorage.setItem("reestablishGameType", data.gameType);
				sessionStorage.setItem("isReestablishingHost", "true"); // Flag that this user was the creator
				window.location.href = `/game/${data.gameType}/${data.roomId}`;
			});

			socket.on("joined_room_success", (data) => {
				alert(`Successfully joined room ${data.roomId}! Game type: ${data.gameType}`);

				sessionStorage.setItem("reestablishRoomId", data.roomId);
				sessionStorage.setItem("reestablishUsername", usernameInput.value.trim()); // Username used for joining
				sessionStorage.setItem("reestablishGameType", data.gameType);
				sessionStorage.setItem("isReestablishingHost", "false"); // Flag for regular joiner

				window.location.href = `/game/${data.gameType}/${data.roomId}`;
			});

			socket.on("custom_error", (error) => {
				console.error("Server error:", error.message);
				alert(`Error: ${error.message}`);
			});

			// Handle username already set if re-visiting home page
			socket.on("connect", () => {
				console.log("Connected to server with socket ID:", socket.id);
				const savedUsername = localStorage.getItem("username");
				if (savedUsername) {
					usernameInput.value = savedUsername;
					socket.emit("set_username", { username: savedUsername });
				} else {
					socket.emit("set_username", { username: "" });
					usernameInput.value = ""; // Clear the input if no saved username
				}

				socket.emit("track_view", { page: "home" });
			});

			usernameInput.addEventListener("change", () => {
				localStorage.setItem("username", usernameInput.value);
				socket.emit("set_username", { username: usernameInput.value });
			});
		</script>
	</body>
</html>
